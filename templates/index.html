<!DOCTYPE html>
<html lang="en" data-theme="light">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Image Uploader</title>
        <link
            href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css"
            rel="stylesheet"
            type="text/css"
        >
        <link rel="stylesheet" href="/static/styles.css">

        <!-- htmx -->
        <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    </head>
    <body>
        <div class="card shadow-2xl bg-base-100">
            <div class="card-body space-y-4">
                <h1 class="card-title justify-center">Image Denoiser</h1>

                <p id="status" class="text-center text-sm text-base-content/70">
                    Select an image
                </p>
                <p
                    class="text-center text-xs text-base-content/60 htmx-indicator"
                >
                    Working...
                </p>

                <div
                    id="image-section"
                    class="flex flex-col md:flex-row gap-4 justify-center items-center"
                >
                    <div id="image-container" class="flex justify-center">
                        <img
                            id="main-image"
                            alt="Selected image preview"
                            style="display: none"
                            class="max-h-80 rounded-lg"
                        >
                    </div>
                    <div class="w-full md:w-auto">
                        {% include "components/image-options.jinja" %}
                    </div>
                </div>

                <!-- Ping server button using htmx -->
                <div class="flex gap-3 justify-center">
                    <button
                        class="btn btn-primary"
                        type="button"
                        hx-get="/api/ping"
                        hx-target="#status"
                        hx-swap="innerHTML"
                    >
                        Ping server
                    </button>
                </div>

                <div class="flex gap-3 justify-center">
                    <div
                        id="dropdown-wrapper"
                        class="w-full"
                        hx-get="/get-image-dropdown"
                        hx-trigger="load"
                        hx-swap="outerHTML"
                        hx-indicator=".htmx-indicator"
                    >
                        {% include "components/dropdown.jinja" %}
                    </div>
                </div>

                <!-- Upload form using htmx -->
                <!-- <form
                    class="form-control gap-3"
                    hx-post="/api/upload"
                    hx-target="#status"
                    hx-swap="innerHTML"
                    enctype="multipart/form-data"
                >
                    <div id="preview-container" class="flex justify-center">
                        <img
                            id="preview-image"
                            alt="Selected image preview"
                            style="display: none"
                        >
                    </div>

                    <input
                        id="file-input"
                        name="file"
                        type="file"
                        accept="image/*"
                        class="file-input file-input-bordered w-full"
                        required
                    >
                    <button type="submit" class="btn btn-secondary w-full">
                        Upload image
                    </button>
                </form> -->
            </div>
        </div>

        <script>
            const statusEl = document.getElementById("status");
            const mainImage = document.getElementById("main-image");
            const defaultImagePath = {{ default_image | default('', true) | tojson }};

            const toImageUrl = (path) =>
                path ? `/select-image?img=${encodeURIComponent(path)}` : "/select-image";

            const imageState = {
                currentPath: defaultImagePath,
                currentBlob: null,
                objectUrl: null,
            };

            const updateStatus = (text) => {
                if (statusEl && text) {
                    statusEl.textContent = text;
                }
            };

            const setMainImageSrc = (src) => {
                if (!mainImage || !src) {
                    return;
                }
                if (imageState.objectUrl) {
                    URL.revokeObjectURL(imageState.objectUrl);
                    imageState.objectUrl = null;
                }
                mainImage.src = src;
                mainImage.style.display = "block";
                if (src.startsWith("blob:")) {
                    imageState.objectUrl = src;
                }
            };

            const loadImageFromPath = (path, label) => {
                imageState.currentPath = path || defaultImagePath;
                imageState.currentBlob = null;
                setMainImageSrc(toImageUrl(imageState.currentPath));
                updateStatus(label || "Image loaded");
            };

            const resetImage = () => {
                imageState.currentBlob = null;
                setMainImageSrc(toImageUrl(imageState.currentPath));
                updateStatus("Image reset");
            };

            const getCurrentImageBlob = async () => {
                if (imageState.currentBlob) {
                    return imageState.currentBlob;
                }

                const response = await fetch(toImageUrl(imageState.currentPath));
                if (!response.ok) {
                    throw new Error("Failed to fetch source image");
                }

                return await response.blob();
            };

            const processImageAction = async (button) => {
                const endpoint = button.dataset.endpoint;
                if (!endpoint) return;

                const method = (button.dataset.method || "post").toUpperCase();
                const actionLabel = button.textContent.trim() || "Action";
                updateStatus(`Running ${actionLabel}...`);
                button.disabled = true;

                try {
                    const blob = await getCurrentImageBlob();
                    const formData = new FormData();
                    const filename =
                        imageState.currentPath.split("/").pop() || "selected-image.png";
                    formData.append("file", blob, filename);

                    const response = await fetch(endpoint, {
                        method,
                        body: formData,
                    });

                    if (!response.ok) {
                        throw new Error("Request failed");
                    }

                    const resultBlob = await response.blob();
                    imageState.currentBlob = resultBlob;
                    const objectUrl = URL.createObjectURL(resultBlob);
                    setMainImageSrc(objectUrl);
                    updateStatus(`${actionLabel} complete`);
                } catch (error) {
                    console.error(error);
                    updateStatus(error.message || "Something went wrong");
                } finally {
                    button.disabled = false;
                }
            };

            document.body.addEventListener("change", (event) => {
                if (event.target.id !== "image-select") return;
                const option = event.target.selectedOptions[0];
                const value = option?.value || "";
                const label = option?.textContent?.trim() || "Image loaded";
                loadImageFromPath(value || defaultImagePath, label);
            });

            document.body.addEventListener("click", (event) => {
                const button = event.target.closest(".image-option");
                if (!button) return;
                event.preventDefault();

                const actionType = button.dataset.actionType || "process";
                if (actionType === "reset") {
                    resetImage();
                    return;
                }

                processImageAction(button);
            });

            loadImageFromPath(defaultImagePath, "Loaded default image");
        </script>
    </body>
</html>
